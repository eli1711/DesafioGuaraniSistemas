<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <title>Novo Pedido</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <style>:root{--bs-primary:#198754}</style>
</head>
<body class="bg-light">
<div class="container mt-4">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <a class="btn btn-outline-success btn-sm" th:href="@{/pedidos}">← Voltar</a>
    <h3 class="mb-0">Novo Pedido</h3>
    <span></span>
  </div>

  <div class="card shadow-sm border-success">
    <div class="card-body">
      <div th:if="${mensagem}" class="alert alert-success" th:text="${mensagem}"></div>
      <div th:if="${erro}" class="alert alert-danger" th:text="${erro}"></div>

      <form th:action="@{/pedidos/salvar}" method="post" class="row g-3 needs-validation" novalidate>

        <!-- CLIENTE selecionável somente para ADMIN/OPERADOR -->
        <div class="col-12" sec:authorize="hasAnyRole('ADMIN','OPERADOR')">
          <label for="clienteId" class="form-label">Cliente</label>
          <select id="clienteId" name="clienteId" class="form-select" required>
            <option value="">Selecione...</option>
            <option th:each="c : ${clientes}"
                    th:value="${c.id}"
                    th:text="${c.nome + ' — ' + c.email}">
            </option>
          </select>
          <div class="invalid-feedback">Selecione um cliente.</div>
        </div>

        <!-- CLIENTE logado: id vai escondido; exibe apenas informações -->
        <div class="col-12" sec:authorize="hasRole('CLIENTE')">
          <!-- envia o id do cliente logado -->
          <input type="hidden" name="clienteId" th:value="${clienteAtual != null ? clienteAtual.id : ''}">
          <div th:if="${clienteAtual != null}" class="alert alert-success mb-0">
            <strong>Cliente:</strong>
            <span th:text="${clienteAtual.nome}"></span>
            <small class="text-muted">(
              <span th:text="${clienteAtual.email}"></span>
            )</small>
          </div>
          <div th:if="${clienteAtual == null}" class="alert alert-warning mb-0">
            Não foi possível identificar seu cadastro de cliente. Contate o suporte.
          </div>
        </div>

        <!-- Produto -->
        <div class="col-12 col-md-8">
          <label for="produtoId" class="form-label">Produto</label>
          <select id="produtoId" name="produtoId" class="form-select" required>
            <option value="">Selecione...</option>
            <option th:each="p : ${produtos}" th:value="${p.id}" th:text="${p.nome}"></option>
          </select>
          <div class="invalid-feedback">Selecione um produto.</div>
        </div>

        <!-- Quantidade -->
        <div class="col-12 col-md-4">
          <label for="quantidade" class="form-label">Quantidade</label>
          <input id="quantidade" name="quantidade" type="number" min="1" class="form-control" required>
          <div class="invalid-feedback">Informe a quantidade.</div>
        </div>

        <div class="col-12 d-flex gap-2 mt-2">
          <!-- Desabilita o submit se cliente logado não tiver clienteAtual -->
          <button type="submit"
                  class="btn btn-success"
                  th:disabled="${#authorization.expression('hasRole(''CLIENTE'')') and clienteAtual == null}">
            Salvar Pedido
          </button>
          <a th:href="@{/pedidos}" class="btn btn-outline-success">Cancelar</a>
        </div>

      </form>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
(()=>{'use strict';const forms=document.querySelectorAll('.needs-validation');
Array.from(forms).forEach(f=>{f.addEventListener('submit',e=>{
  if(!f.checkValidity()){e.preventDefault();e.stopPropagation()}
  f.classList.add('was-validated')
},false)})})();
</script>
</body>
</html>
